rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper function to check if user is a participant in the conversation
    function isParticipant(participantIds) {
      return isAuthenticated() && participantIds.hasAny([request.auth.uid]);
    }

    // Helper function to check if this is a test operation
    function isTestEmail(email) {
      return email == 'testhost@example.com' || email == 'testrenter@example.com';
    }

    function isTestData() {
      return ('email' in resource.data && isTestEmail(resource.data.email)) ||
             ('hostEmail' in resource.data && isTestEmail(resource.data.hostEmail)) ||
             ('renterEmail' in resource.data && isTestEmail(resource.data.renterEmail)) ||
             ('senderId' in resource.data && isTestEmail(resource.data.senderId)) ||
             ('receiverId' in resource.data && isTestEmail(resource.data.receiverId));
    }

    // Events rules
    match /events/{eventId} {
      allow read: if true;  // Allow public read access
      allow write: if isAuthenticated() && request.auth.token.admin == true;
    }

    // Driveways rules
    match /driveways/{drivewayId} {
      allow read: if true;  // Allow public read access
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && isOwner(resource.data.ownerId);
    }

    // Parking spots rules
    match /parkingSpots/{spotId} {
      allow read: if true;  // Allow public read access
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && isOwner(resource.data.ownerId);
    }

    // Bookings rules
    match /bookings/{bookingId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.userId || 
        request.auth.uid == resource.data.hostId
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.userId || 
        request.auth.uid == resource.data.hostId
      );
      allow delete: if isAuthenticated() && (
        request.auth.uid == resource.data.userId || 
        request.auth.uid == resource.data.hostId
      );
    }

    // User profiles rules
    match /users/{userId} {
      allow read: if true;  // Allow reading user profiles
      allow create: if true;  // Allow creating test users
      allow update: if isOwner(userId);
      allow delete: if resource.data.email == 'testhost@example.com' || resource.data.email == 'testrenter@example.com';  // Allow deleting test users
    }

    // Messages rules
    match /messages/{messageId} {
      allow read: if true;  // Allow reading messages for testing
      allow create: if true;  // Allow creating messages for testing
      allow update: if true;  // Allow updating messages for testing
      allow delete: if true;  // Allow deleting test messages
    }

    // Conversations rules
    match /conversations/{conversationId} {
      allow read: if true;  // Allow reading conversations for testing
      allow create: if true;  // Allow creating conversations for testing
      allow update: if true;  // Allow updating conversations for testing
      allow delete: if true;  // Allow deleting test conversations

      match /messages/{messageId} {
        allow read: if true;
        allow write: if true;
      }
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 